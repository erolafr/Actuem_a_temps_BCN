---
title: "2CalculDensitats"
author: "Erola Fenollosa"
date: "14/12/2021"
output: github_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introducció i descarrega de paquets
L'objectiu d'aquest codi és generar el càlcul de les densitats de presència de les espècies susceptibles a ser invasores a la ciutat de Barcelona del projecte "Actuem a temps: espècies susceptibles de ser invasores a la ciutat de Barcelona". El codi permetrà calcular el nombre de registres/m2 mitjà que hi ha a la ciutat de forma global i també per a cada espècie, possibilitat també l'anàlisi de zones en concret introduint polígons d'espais amb major esforç de mostreig o amb alguna peculiaritat.

Carreguem els paquets necesaris:
```{r}
library('sf')
library(dplyr)
library(leaflet)
library(raster)
```

Carreguem el dataset generat per 1Descarrega.Rmd:
```{r}
actpns <- read.csv(file = 'actpns.csv')
```

## Delimitació de l'àrea global del projecte
En primer lloc necesitem quantificar l'àrea del projecte. Es va definir el projecte a iNaturalist (https://www.inaturalist.org/projects/especies-susceptibles-a-ser-invasores-a-barcelona-actuem-a-temps?tab=about) en l'àrea del Barcelonés (https://www.inaturalist.org/places/140344), però cal descarregar una capa per a calcular l'àrea que suposa aquest polígon. A wikipèdia s'indica que l'àrea ocupa 145,75 km², però volem desenvolupar el codi per a poder mesurar-la. 

Podem descarregar un csv amb els limits del Barcelonés a partir de https://vangdata.carto.com/tables/shapefiles_catalunya_comarcas/public/map. Descarreguem els arxius del Barcelonés i els posem a la carpeta. 

```{r}
barcelones <- shapefile('shapefiles_catalunya_comarcas/shapefiles_catalunya_comarcas.shp')
plot(barcelones)
```

N'obtenim l'àrea en Km2:
```{r}
area(barcelones)/1000000
```

### Mapa dels registres
En primer lloc filtrarem els registres dins l'àrea (teòricament haurien de entrar tots dins l'àrea). Per a fer-ho convertirem el dataframe de iNaturalist amb les dades de registres a un objecte de tipus sf. Més informació a https://ucanr-igis.github.io/tech_notes/inaturalist_map.html 
```{r}
inat_obs_sf <-  actpn %>% 
  st_as_sf(coords=c("longitude", "latitude"), crs=4326)

dim(inat_obs_sf)
```

Fem el filtratge de l'àrea, per a fer-ho necesitem transformar el shp de l'àrea en un sf, el tornem a carregar amb la funció st_read:
```{r}
barcelones <- st_read('shapefiles_catalunya_comarcas/shapefiles_catalunya_comarcas.shp')

inat_obs_pcsp_sf  <- inat_obs_sf %>% st_intersection(barcelones)
nrow(inat_obs_pcsp_sf)
```

Preparem un pop-up per al mapa amb els registres per a poder veure informació de cadascun.
Podrem afegir també la imatge introduint la localització dins del dataset del url. Es troba dins de photos --> small_url, on photos és una variable de tipus list dins del dataframe:
```{r}
inat_obs_pcsp_popup_sf <- inat_obs_pcsp_sf %>% 
  mutate(popup_html = paste0("<p><b><i>", taxon.name, "</b><br/></i>",
                             "User: ", user_login, "</p>",
                             "<p><img src='", photos[[1]]$small_url, "' style='width:100%;'/></p>"))
```


Creem el mapa online amb leaflet. Només es visualitza correctament en R:
```{r}
leaflet(barcelones) %>% 
  addProviderTiles("Esri.WorldStreetMap") %>% 
  addPolygons() %>% 
  addCircleMarkers(data = inat_obs_pcsp_popup_sf,
                   popup = ~popup_html, 
                   radius = 1)
```




